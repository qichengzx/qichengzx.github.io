
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>

  启程
  

</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link href="/css/style.css" rel="stylesheet" type="text/css">
<meta property="og:type" content="website">
<meta property="og:title" content="启程">
<meta property="og:url" content="https://www.qichengzx.com">
<meta property="og:site_name" content="启程">
<meta property="og:description" content="记录写代码过程中的成长，不要把你仅知道的那一点点东西当成全世界">
<link rel="icon" href="/favicon.ico">

</head>
<body>
<div id="container">
  <div id="wrap">
    
        <header id="header">
          <div id="banner"></div>
          <div id="header-outer" class="outer">
            <div id="header-title" class="inner">
              <h1 id="logo-wrap">
                <a href="https://www.qichengzx.com" id="logo">启程</a>
              </h1>
              
            </div>
            <div id="header-inner" class="inner">
              <nav id="main-nav">
                <a id="main-nav-toggle" class="nav-icon"></a>
                
                <a class="main-nav-link" href="/">Home</a>
                
                <a class="main-nav-link" href="/archives">Archives</a>
                
                <a class="main-nav-link" href="https://github.com/qichengzx">GitHub</a>
                
              </nav>
              <nav id="sub-nav">
              
                <a id="nav-search-btn" class="nav-icon" title="Search"></a>
              </nav>
              <div id="search-form-wrap">
                <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form">
                  <input type="search" name="q" class="search-form-input" placeholder="Search">
                  <button type="submit" class="search-form-submit">&#xF002;</button>
                  <input type="hidden" name="sitesearch" value="https://www.qichengzx.com">
                </form>
              </div>
            </div>
          </div>
        </header>

    <div class="outer">
      <section id="main">
      
        
        
                <article id="20dc7a4d7acd076d813c37a19293c4e1" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/09/16/convert-xml-to-json-in-golang.html" class="article-date">
                      <time itemprop="datePublished">2016-09-16 11:28:20</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/golang">golang</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/09/16/convert-xml-to-json-in-golang.html">Golang XMl 转 JSON</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <p><img src="/images/golang.png" alt="" /></p>

<h4>起因</h4>

<p>某个上古时代的API，依然在返回XML格式的数据，更奇葩的是，GBK格式的。</p>

<p>用Go顺利的写到了发送数据，接收数据，然后取值有点麻烦啊。。。。</p>

<p>各种Google后，终于解决，但是不保证是唯一，正确，最合适的答案。</p>

<h4>说在前边</h4>

<p>本文假设要解析的XMl数据为：</p>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;GBK&quot; ?&gt;
&lt;response&gt;
    &lt;status&gt;200&lt;/status&gt;
&lt;/response&gt;
</code></pre>

<p>要解决的问题是取出“200”这个状态值。</p>

<h4>导入包</h4>

<p>解析XML使用了&rdquo;encoding/xml&rdquo;这个包。</p>

<p>所以先导入这个包。</p>

<pre><code class="language-go">import &quot;encoding/xml&quot;
</code></pre>

<h4>定义struct</h4>

<p>定义一个自定义类型的Response</p>

<pre><code class="language-go">type Response struct {
    Status int `xml:&quot;status&quot; json:&quot;status&quot;`
}
</code></pre>

<p>定义一个Response类型的变量</p>

<pre><code class="language-go">var result Response
</code></pre>

<h4>偷懒转格式</h4>

<p>因为&rdquo;encoding/xml&rdquo;不支持GBK格式的XML，而返回的内容又固定标明了编码是GBK，所以这里偷懒，直接把GBK替换成UTF-8，本例中不影响结果。</p>

<pre><code class="language-go">xmlstr := `?xml version=&quot;1.0&quot; encoding=&quot;GBK&quot; ?&gt;
&lt;response&gt;
    &lt;status&gt;200&lt;/status&gt;
&lt;/response&gt;
`
xmlstr = strings.Replace(xmlstr, &quot;GBK&quot;, &quot;UTF-8&quot;, -1)
</code></pre>

<p>使用strings包，替换“GBK”，相信根据参数顺序能看出各个参数的意义，最后一个参数：-1，为替换全部，即字符串中所有出现的第二个参数全部替换。</p>

<h4>解析，转换，取值</h4>

<p>使用encoding/jon，go-simplejson包</p>

<pre><code class="language-go">//解析XML
err := xml.Unmarshal([]byte(xmlstr), &amp;result)

if nil != err {
  log.Fatal(err)
}
log.Printf(&quot;XML:%v \n&quot;, result) 

//转换成JSON
res, err := json.Marshal(result)

if nil != err {
  log.Fatal(err)
}
log.Printf(&quot;JSON:%s \n&quot;, res)

js, err := simplejson.NewJson([]byte(res))

if nil != err {
  log.Fatal(err)
}
status, err := js.Get(&quot;status&quot;).Int()

log.Printf(&quot;STATUS:%v \n&quot;, status)
</code></pre>

<p>以上是本人在处理XML 转 JSON 时的解决办法，应该还有更简单更合适的方案。仅供参考。</p>

<h4>完整代码：</h4>

<pre><code class="language-go">package main
import (
    &quot;encoding/xml&quot;
    &quot;encoding/json&quot;
    &quot;log&quot;
    &quot;strings&quot;
    simplejson &quot;github.com/bitly/go-simplejson&quot;
)
type Response struct {
    Status int `xml:&quot;status&quot; json:&quot;status&quot;`
}

func main() {
    
    var result Response

    //多行字符串，使用反引号`
    xmlstr := `&lt;?xml version=&quot;1.0&quot; encoding=&quot;GBK&quot; ?&gt;
&lt;response&gt;
    &lt;status&gt;200&lt;/status&gt;
&lt;/response&gt;`

    xmlstr = strings.Replace(xmlstr, &quot;GBK&quot;, &quot;UTF-8&quot;, -1)

    err := xml.Unmarshal([]byte(xmlstr), &amp;result)
    if err != nil {
        log.Fatal(err)
    }
    log.Printf(&quot;XML:%v&quot;,result)

    r, err := json.Marshal(result)
    if nil != err {
        log.Fatal(err)
    }

    log.Printf(&quot;JSON:%s&quot;, r)

    js, err := simplejson.NewJson([]byte(r))

    if nil != err {
        log.Fatal(err)
    }
    status, err := js.Get(&quot;status&quot;).Int()
    log.Printf(&quot;VALUE:%v&quot;,status)

}
</code></pre>

<h4>发现问题：</h4>

<p>今天（2016-09-18），再看这段代码，发现跟另一个程序里有些不一样。</p>

<p>另一个程序里是这样的：</p>

<pre><code>type Response struct {
    Status int `xml:&quot;status&quot;
}
</code></pre>

<p>也可以正常返回值，但是在本文中的示例却不能正常输出status值，而是会输出空，看了半天发现，使用 log 时：</p>

<pre><code>log.Printf(&quot;VALUE:%v&quot;,status)
</code></pre>

<p>如果struct没有写
“json:&ldquo;status&rdquo;”，就不能输出，如果换成fmt，struct就可以不写“json:&ldquo;status&rdquo;。结果是一样的，其中的原因还要再查资料研究下。</p>

<p>参考文章：</p>

<p><a href="http://blog.studygolang.com/2012/12/%e6%a0%87%e5%87%86%e5%ba%93-xml%e5%a4%84%e7%90%86%ef%bc%88%e4%b8%80%ef%bc%89/">标准库—XML处理（一）</a></p>

<p><a href="https://play.golang.org/p/7HNLEUnX-m">https://play.golang.org/p/7HNLEUnX-m</a></p>

<p><a href="https://play.golang.org/p/m99B12RaLe">https://play.golang.org/p/m99B12RaLe</a></p>

<p><a href="https://astaxie.gitbooks.io/build-web-application-with-golang/content/zh/07.1.html">XML处理</a></p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/09/16/convert-xml-to-json-in-golang.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/go">go</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="67d9fcb5042c673afa2a38584d6f61e4" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/09/11/Hello-Go.html" class="article-date">
                      <time itemprop="datePublished">2016-09-11 17:21:03</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/golang">golang</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/09/11/Hello-Go.html">Hello Go</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <h5>Mac 安装 GO</h5>

<p>本人使用了Brew来安装。</p>

<h5>安装前首先更新Brew。</h5>

<pre><code>brew update &amp;&amp; brew upgrade
</code></pre>

<h5>安装Go</h5>

<p>使用brew安装go</p>

<pre><code>brew install go
</code></pre>

<h5>设置$GOPATH</h5>

<p>Go从1.1版本开始必须设置这个变量，也就是说通过以上方式安装后就必须要设置$GOPATH了。</p>

<p>这个目录用来存放Go源码，可运行文件，和编译之后的包文件。</p>

<p>Mac系统设置</p>

<p>在bash中加入：</p>

<pre><code class="language-shell">export GOPATH=/your/path
</code></pre>

<p>以上目录需要存在，不存在就自己手动创建一个。</p>

<p>然后运行</p>

<pre><code class="language-shell">source ~/.zshrc
</code></pre>

<p>替换成你自己使用的shell，如.bashrc等。</p>

<p>然后，需要在/your/path目录下，新建 pkg，bin，src目录。</p>

<p>​   src目录存放源代码，如hello.go</p>

<p>​   pkg目录存放编译后的文件，如hello.a</p>

<p>​   bin目录存放生成后的可执行文件</p>

<p>src目录就是主要开发目录。如hello项目，则在src下新建hello目录。</p>

<p>到这里，就可以开始Go之旅了。</p>

<h5>Hello Go</h5>

<p>需要注意的是，在Go中，包名和文件名是可以不同的，包名为main的时候即为可以独立运行的包。</p>

<p>在src目录新建hello目录，创建hello.go文件。</p>

<pre><code class="language-go">package main //包名

import &quot;fmt&quot; //导入一个系统级别的fmt包

//使用func定义函数
//main函数没有参数，没有返回值
func main() {
  fmt.Println(&quot;Hello Go&quot;) //调用包函数的方法为 pkgName.funcName
}
</code></pre>

<p>一个hello.go就写好了，在命令行输入</p>

<pre><code class="language-go">go run hello.go
</code></pre>

<p>就可以看到输出Hello Go了。</p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/09/11/Hello-Go.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/go">go</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="783fd7716cf7dbd4cf58a246310e60e4" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/07/02/php-post-file-with-curl.html" class="article-date">
                      <time itemprop="datePublished">2016-07-02 23:11:30</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/07/02/php-post-file-with-curl.html">PHP Curl 上传文件</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <p>有时候会遇到上传文件给第三方服务的情况，比如本身程序并不需要存储附件，而是把附件发送给一个公共的服务。</p>

<p>最近正好碰到这个问题，记录一下。</p>

<p>上代码。</p>

<h4>发送端：</h4>

<pre><code class="language-php">&lt;?php

// 接口地址
$api = 'http://api.example.com/uploadfile';
$file = $_FILES['file'];//保存$_FILES到变量中。

// 此处可能存在上传失败等问题，需验证$_FILES[&quot;file&quot;][&quot;error&quot;]。
// 做业务对应的规则验证，如文件格式，文件大小等。

// 创建一个 cURL 句柄
$ch = curl_init($api);

// 创建一个 CURLFile 对象
// 上传文件的路径，文件的Mimetype，文件名
$cfile = curl_file_create($file['tmp_name'],$file['type'],$file['name']);

$data = [
	'type'=&gt;'image',
	'data'=&gt;$cfile
];

// 设置 POST 数据
curl_setopt($ch, CURLOPT_POST,1);
curl_setopt($ch, CURLOPT_POSTFIELDS, $data);

$resp = curl_exec($ch);

if(!$resp) {
  die('Error: &quot;' . curl_error($ch) . '&quot; - Code: ' . curl_errno($ch));
} else {
  echo &quot;Response HTTP Status Code : &quot; . curl_getinfo($ch, CURLINFO_HTTP_CODE);
  echo &quot;\nResponse HTTP Body : &quot; . $resp;
}

// Close request to clear up some resources
curl_close($ch);
</code></pre>

<h4>接收端：</h4>

<pre><code class="language-php">&lt;?php 
var_dump($_FILES);// 接收文件内容
va_dump($_POST);// 接收type
</code></pre>

<h4>前端：</h4>

<p>前端可使用Form或其他Ajax方式上传。</p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/07/02/php-post-file-with-curl.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="4eff8f0fed4453350d3813f4852fcac7" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/05/15/a-sample-redis-queue.html" class="article-date">
                      <time itemprop="datePublished">2016-05-15 14:19:52</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/05/15/a-sample-redis-queue.html">一个简单的php&#43;redis队列示例</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <p><img src="/images/redis/redis-300dpi.png" alt="" /></p>

<p>虽然RabbitMQ的坑年前就开始填了，但是并没有机会在项目中实际使用，机缘巧合，换工作后第一个比较重要的事就是做一个直播的页面，如果数据直接插入或读取自数据库，数据库端的压力就太大了，当时RabbitMQ还没看完，而其他的队列程序更是没有用过，只是稍微对Redis熟悉些，于是就使用了Redis做。</p>

<p><a href="http://redis.io/">Redis</a>比较常见的是作为数据缓存工具使用，数据存储在内存中，减少了数据库的连接和查询，效率高，又方便。</p>

<p>而其实Redis也可以用来做消息队列。</p>

<h3>发送</h3>

<p>发送端首先当然是做好数据的接收和检测，比如为空的情况下给个默认值或返回错误。</p>

<p>特殊的情况下可能还要正则处理。</p>

<p>处理完插入到Redis的list(<a href="http://www.redis.cn/topics/data-types-intro.html#lists">列表</a>)中。如果插入失败抛出异常。</p>

<pre><code class="language-php">&lt;?php

$redis = new Redis();
$redis-&gt;connect('127.0.0.1');

//如果redis需要认证
$redis-&gt;auth('redispasswd');

//命令行中使用，可以使用把信息作为参数的方式
$data = $argv[1];
if(empty($data)) $data = &quot;Hello World..!&quot;:

try{
	//便于调试，在信息后边加上当前时间
	$data .= '-at-'.date('Y-m-d H:i:s');
	$redis-&gt;LPUSH('redis_queue_1',json_encode($data));
}catch(Exception $e){
	echo $e-&gt;getMessage().&quot;\n&quot;;
}
</code></pre>

<h4>执行</h4>

<pre><code class="language-shell">php push.php &quot;testinfo&quot;
</code></pre>

<h3>接收</h3>

<p>由于消息是源源不断发送到队列中，所以接收端程序一般会以后台进程的方式运行。</p>

<pre><code class="language-php">&lt;?php
$redis = new Redis();
$redis-&gt;connect('127.0.0.1');

$redis-&gt;auth('redispasswd');

while (true) {

	try {
		$data = $redis-&gt;rPopLPush('redis_queue_1','redis_queue_1_bak').&quot;\n&quot;;
		if($data){
			echo $data;
		}else{
			echo &quot;没有数据\n&quot;;
		}
	} catch (Exception $e) {
		echo $e-&gt;getMessage().&quot;\n&quot;;
	}

	//每秒读取1次
	sleep(1);
}
</code></pre>

<h4>执行</h4>

<pre><code class="language-shell">php get.php
</code></pre>

<h3>更进一步</h3>

<p>如果想把数据写入到MySQL中，该怎么办？</p>

<p>大多数情况下数据最终是需要持久化的，仅仅存在于redis中，也许内存会不够呢。</p>

<p>改造一下get.php。</p>

<pre><code class="language-php">&lt;?php
$redis = new Redis();
$redis-&gt;connect('127.0.0.1');

$redis-&gt;auth('redispasswd');

$dsn = 'mysql:dbname=test;host=127.0.0.1';

try{
	$pdo = new PDO($dsn,'root','mysqlpasswd',array(PDO::MYSQL_ATTR_INIT_COMMAND =&gt; 'SET NAMES utf8'));
}catch(PDOExcetion $e){
	echo $e-&gt;getMessage().&quot;\n&quot;;
}

while(true){
	$data = $redis-&gt;rPopLPush('redis_queue_1','redis_queue_1_bak');
	if($data){
		$sth = $pdo-&gt;prepare(&quot;INSERT INTO tb_test(msg,time) VALUES (:msg,:time)&quot;);
		
		$time = time();
		
		$sth-&gt;bindParam(':msg',$data,PDO::PARAM_STR);
		$sth-&gt;bindParam(':time',$time,PDO::PARAM_INT);
		
		$sth-&gt;execute();
		$id = $pdo-&gt;lastInsertId();
      
		echo &quot;插入成功，ID=$id \n&quot;;
	}else{
		echo &quot;没有数据 \n&quot;;
	}
	
	//实际任务中可能需要尽可能快的把数据导入到MySQL中
	sleep(1);
}
</code></pre>

<h4>注意</h4>

<p>​   这里使用了<a href="http://php.net/manual/zh/book.pdo.php">PDO</a>;</p>

<p>​   <a href="http://php.net/manual/zh/pdostatement.bindparam.php">bindParam</a>方法的第一个参数对应insert语句中的对应顺序的值，如第一个bindParam方法对应第一个value值。</p>

<p>​   bindParam方法第二个参数为实际的值，传入变量或固定值，传入方法调用时如time()会提示：</p>

<p>Strict standards: Only variables should be passed by reference in /www/get.php on line 24。</p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/05/15/a-sample-redis-queue.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/redis">redis</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/%e9%98%9f%e5%88%97">队列</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="e6b6b8988e6e1fb380bddb3d8a4fb687" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/05/08/cant-post-iqiyi-video-to-discuz.html" class="article-date">
                      <time itemprop="datePublished">2016-05-08 18:57:24</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/javascript">javascript</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/05/08/cant-post-iqiyi-video-to-discuz.html">解决Discuz无法发布爱奇艺视频的问题</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <p><img src="/images/discuz/201510148054_136.jpg" alt="" /></p>

<p>最近碰到需要在Discuz论坛中插入爱奇艺视频的问题，之前没关注过，搜索后有些答案说DZ不支持爱奇艺，有些说爱奇艺不支持DZ，并没有真正能解决问题的。</p>

<p>下午突然想到也许是DZ根据粘贴进来的flash地址生成的标签代码不对，试验后发现果然是这个原因。</p>

<p>打卡/static/js/editor.js 文件第1299行查看这段代码：</p>

<pre><code class="language-js">case 'vid':
	var mediaUrl = $(ctrlid + '_param_1').value;
	var auto = '';
	var posque = mediaUrl.lastIndexOf('?');
	posque = posque === -1 ? mb_strlen(mediaUrl) : posque;
	var ext = mediaUrl.lastIndexOf('.') === -1 ? '' : mediaUrl.substring(mediaUrl.lastIndexOf('.') + 1, posque).toLowerCase();
	ext = in_array(ext, ['mp3', 'wma', 'ra', 'rm', 'ram', 'mid', 'asx', 'wmv', 'avi', 'mpg', 'mpeg', 'rmvb', 'asf', 'mov', 'flv', 'swf']) ? ext : 'x';
	if(ext == 'x') {
		if(/^mms:\/\//.test(mediaUrl)) {
			ext = 'mms';
		} else if(/^(rtsp|pnm):\/\//.test(mediaUrl)) {
			ext = 'rtsp';
		}
	}
	var str = '[media=' + ext + ',' + $(ctrlid + '_param_2').value + ',' + $(ctrlid + '_param_3').value + ']' + squarestrip(mediaUrl) + '[/media]';
	insertText(str, str.length, 0, false, sel);
	break;
</code></pre>

<p>Discuz根据主流的视频网站的视频地址格式写的规则，生成discuz专用的[media]标签，在前台输出的时候再解析成embed这样的HTML代码。</p>

<p>解析之后的差不多就是这样：</p>

<pre><code class="language-html">&lt;embed src=&quot;http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1&quot; allowFullScreen=&quot;true&quot; quality=&quot;high&quot; width=&quot;480&quot; height=&quot;350&quot; align=&quot;middle&quot; allowScriptAccess=&quot;always&quot; type=&quot;application/x-shockwave-flash&quot;&gt;&lt;/embed&gt;
</code></pre>

<p>而不那么主流的爱奇艺的flash地址则是：”<a href="http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。">http://player.video.qiyi.com/7b42a1a27ff121c201ee5e6c6d757817/0/0/v_19rrklq2bs.swf-albumId=406283300-tvId=406283300-isPurchase=2-cnId=1”，查看上一段代码可以看到，discuz会用正则去看粘贴的地址最后一个&quot;.&quot;后的后缀，如果这个后缀不在自己的已知flash格式数组中，就把类型设为&quot;x&quot;，也就是生成的标签成了[media=x,500,350]。</a></p>

<p>再到了前台解析，不认识，直接生成一个a标签。</p>

<p>所以，我的解决办法是：</p>

<pre><code class="language-js">if(ext == 'x') {
	if(/^mms:\/\//.test(mediaUrl)) {
		ext = 'mms';
	} else if(/^(rtsp|pnm):\/\//.test(mediaUrl)) {
		ext = 'rtsp';
	} else if (mediaUrl.indexOf('player.video.qiyi.com')) {
  		ext = 'swf';	
	}
}
</code></pre>

<p>增加一个else if 判断是否包含爱奇艺播放器的域名，当用户粘贴的flash地址包含这个字符串时，就认为是粘贴了一个爱奇艺的视频，存储的格式也就成了[media=swf]。</p>

<p>但是这里其实不是十分严谨，如果一个非法的flash地址很巧合的包含了这个字符串，也会认为是flash了，那这种情况下就会出错了。</p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/05/08/cant-post-iqiyi-video-to-discuz.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/js">js</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/discuz">discuz</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/%e7%88%b1%e5%a5%87%e8%89%ba">爱奇艺</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="0c9c228f8a888369d16026dd1e99f2f0" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html" class="article-date">
                      <time itemprop="datePublished">2016-05-03 14:35:20</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html">PHP RabbitMQ 教程（六） - 远程调用</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <h3>远程调用</h3>

<p>在<a href="/2016/04/17/php-rabbitmq-tutorial-two.html">第二节</a>中，我们学习了如何使用工作队列在多个worker中分发耗时任务。</p>

<p>但是如果我们需要在远程运行一个函数并等待返回结果怎么办？这是两码事，这个模式通常被称为远程过程调用（Remote Procedure Call，RPC）。</p>

<p>在本节中我们准备使用RabbitMQ构建一个RPC系统：一个客户端和一个可扩展的RPC服务端。由于我们没有值得分发的耗时任务，我们准备创建一个假的返回<a href="https://en.wikipedia.org/wiki/Fibonacci_number">斐波那契数列</a>的RPC服务。</p>

<h3>客户端接口</h3>

<p>我们创建一个简单的客户端类来说明RPC服务如何使用。这个类会展示call方法如何发送一个RPC请求并且阻塞，直到接收到返回值。</p>

<pre><code class="language-php">$fibonacci_rpc = new FibonacciRpcClient();
$response = $fibonacci_rpc-&gt;call(30);
echo &quot;[.] Got &quot;, $response, &quot;\n&quot;;
</code></pre>

<h4>RPC注意事项</h4>

<p>尽管RPC在计算机学中很常见，但它十分挑剔。当程序员不知道是否是调用一个本地的方法还是一个很慢的RPC会出现这个问题。这样的困惑便导致不可预测的系统并增加不必要的调试复杂性。比起简化的软件，误用RPC会导致不可维护的无头绪代码。</p>

<p>记住刚才的内容，考虑下面的建议：</p>

<p>​   确保可以明显的看出哪个方法调用的是本地的哪个是远程的。</p>

<p>​   系统文档化。让组件之间的依赖变得清晰可见。</p>

<p>​   错误处理。当RPC服务长时间关闭客户端该作何反应？</p>

<p>如果有疑问，则尽量避免使用RPC。如果可以话，你应该使用异步管道——而不是RPC——像阻塞，结果被异步推送到下个计算阶段。</p>

<h3>回调队列</h3>

<p>通常在RabbitMQ上做RPC很简单。客户端发送请求消息，服务端回复消息。为了接收响应消息，我们需要在请求中附带一个&rdquo;callback&rdquo;队列地址，我们可以使用默认的队列。来试一试：</p>

<pre><code class="language-php">list($queue_name, ,) = $channel-&gt;queue_declare(&quot;&quot;, false, false, true, false);

$msg = new AMQPMessage(
	$payload,
	array('reply_to' =&gt; $queue_name));

$channel-&gt;basic_publish($msg, '', 'rpc_queue');

# ... then code to read a response message from the callback_queue
</code></pre>

<h4>消息属性</h4>

<p>AMQP协议定义了14个消息属性。大部分不常用，下面的除外：</p>

<p>​   delivery_mode：值为2时表示持久化，1为临时的。也许你还记得这个属性来自第二节。</p>

<p>​   content_type：编码格式，比如经常用的JSON格式，良好的做法是设置为：application/json。</p>

<p>​   reply_to：通常用来定义回调队列名称。</p>

<p>​   correlation_id：用来关联RPC的响应和请求。</p>

<h3>Correlation Id</h3>

<p>在上面的方法中我们建议为每一个RPC请求创建一个回调队列。这样非常低效，但是幸运的是有更好的办法 - 我们可以为每一个客户端创建一个单独的回调队列。</p>

<p>这样又带来一个新的问题，在队列接收到响应时，并不知道属于哪个请求。这也正是correlation_id属性要发挥的作用。我们为每一个请求的设定一个唯一的correlation_id值，然后，当在回调队列接收到消息时会查看它的属性，基于此，我们就可以把响应和请求进行匹配。如果发现一个未知的correlation_id值，可以安全的忽略掉这条消息 - 因为它不属于任何请求。</p>

<p>也许你会问，为什么应该忽略回调队列里的未知消息，而不是返回一个错误？因为服务可能会出现紊乱的情况，虽然不太可能，但是如果发生这种情况，RPC服务会在发送完响应后挂掉，但是还没有进行消息确认。如果发生了，重启RPC服务后会再次处理这个请求。这就是为什么在客户端我们必须适当的处理重复请求，而RPC服务最好的幂等的。</p>

<h3>总结</h3>

<p><img src="/images/rabbitmq/python-six.png" alt="" /></p>

<p>RPC工作流程：</p>

<p>​   当客户端开始运行时会创建一个匿名独有回调队列。</p>

<p>​   RPC请求中，客户端消息带有两个属性：reply_to用来设置回调队列，correlation_id用来唯一标识每一个请求。</p>

<p>​   请求被发送到rpc_queue队列。</p>

<p>​   RPC worker（又称worker）在队列中守护，等待新请求。当请求到达，它会进行处理，然后把结果以消息的形式发送回客户端的队列，队列名便是客户端消息带有的reply_to的值。</p>

<p>​   客户端等待回调队列中的数据。当消息到达，检查它的correlation_id的值。如果符合客户端发送给RPC服务器中请求的值，客户端会返回响应内容到应用中。</p>

<h3>整合</h3>

<p>斐波那契方法：</p>

<pre><code>function fib($n){
  if($n == 0)
  	return 0;
  if($n == 1)
  	return 1;
  return fib($n-1) + fib($n-2);
}
</code></pre>

<p>定义完斐波那契方法。假定它仅接受数字类型的输入。（别期望它能处理大的数字，它很可能非常慢的处理完。）</p>

<p>RPC服务处理程序rpc_server.php：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection-&gt;channel();

$channel-&gt;queue_declare('rpc_queue', false, false, false, false);

fuction fib($n){
  if($n == 0)
    return 0;
  if($n == 1)
    return 1;
  
  return fib($n-1) + fib($n-2);
}

echo &quot; [x] Awaiting RPC requests\n&quot;;

$callback = function($req){
  $n = intval($req-&gt;body);
  echo &quot; [.] fib(&quot;,$n,&quot;)\n&quot;;
  
  $msg = new AMQPMessage(
  	(string)fib($n),
    array('correlation_id' =&gt; $req-&gt;get('correlation_id'))
  );
  
  $req-&gt;delivery_info['channel']-&gt;basic_publish($msg, '', $req-&gt;get('reply_to'));
  $req-&gt;delivery_info['channel']-&gt;basic_ack($req-&gt;delivery_info['delivery_tag']);
};

$channel-&gt;basic_qos(null, 1, null);
$channel-&gt;basic_consume('rpc_queue', '', false, false, false, false, $callback);

while(count($channel-&gt;callbacks)){
  $channel-&gt;wait();
}

$channel-&gt;close();
$connection-&gt;close();

?&gt;
</code></pre>

<p>服务端代码相当简单：</p>

<p>​   和以往一样我们会从创建连接，频道，和声明队列开始</p>

<p>​   也许我们想要运行更多的进程。为了在多个服务器之间负载均衡，需要在$channel.basic_qos中设置prefech_count；</p>

<p>​   我们使用basic_consume访问队列。然后进入while循环等待请求消息，处理，然后返回响应消息。</p>

<p>RPC客户端 rpc_client.php：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

class FibonacciRpcClient{
	private $connection;
	private $channel;
	private $callback_queue;
	private $response;
	private $corr_id;
  
	public function __construct(){
		$this-&gt;connection = new AMQPStreamConnection(
		  'localhost', 5672, 'guest', 'guest'
		);
		$this-&gt;channel = $this-&gt;connection-&gt;channel();
		list($this-&gt;callback_queue, ,) = $this-&gt;channel-&gt;queue_declare(&quot;&quot;, false, false, true, false);
		$this-&gt;channel-&gt;basic_consume(
			$this-&gt;callback_queue, '', false, false, false, false,
			array($this, 'on_response'));
	}
  
 	public function on_response($req){
 		if($req-&gt;get('correlation_id') == $this-&gt;corr_id){
 			$this-&gt;response = $req-&gt;body;
 		}
 	}
  	
	public function call($n){
		$this-&gt;response = null;
		$this-&gt;corr_id = uniqid();

		$msg = new AMQPMessage(
  		(string) $n,
  		array(
  			'correlation_id' =&gt; $this-&gt;corr_id,
  			'reply_to' =&gt; $this-&gt;callback_queue)
  		);
    )
      
    $this-&gt;channel-&gt;basic_publish($msg, '', 'rpc_queue');
    while(!$this-&gt;response){
    	$this-&gt;channel-&gt;wait();
    }
    return intval($this-&gt;response);
  }
};

$fibonacci_rpc = new FibonacciRpcClient();
$response = $fibonacci_rpc-&gt;call(30);
echo &quot; [.] Got &quot;, $response, &quot;\n&quot;;

?&gt;
</code></pre>

<p>现在可以查看示例的完整代码了。<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_client.php">rpc_client.php</a> 和 <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/rpc_server.php">rpc_server.php</a>。</p>

<p>现在RPC服务端可以运行了：</p>

<pre><code class="language-shell">php rpc_server.php
[x] Awiting RPC resquests
</code></pre>

<p>接收斐波那契数列运行：</p>

<pre><code>php rpc_client.php
[x] Requesting fib(30)
</code></pre>

<p>这里展现的并不是RPC服务的唯一可能实现，但它有一些重要的优势：</p>

<p>​   如果RPC服务太慢，可以按比例增加运行数量。试试在新控制台裕兴第二个rpc_server.php服务。</p>

<p>​   在客户端，RPC要求只发送和接收一条消息。不能有像队列声明一样的异步调用。结果就是，对于单一的RPC请求，客户端仅需要一个网络往返。</p>

<p>现在的代码还是过于简单，并没有想解决更复杂（更重要）的问题，比如：</p>

<p>​   要是没有服务端守护运行，客户端作何反应？</p>

<p>​   RPC客户端是否需要设置超时？</p>

<p>​   如果服务端引发异常，是否该把它发送到客户端？</p>

<p>​   处理前阻止无效消息（如检查范围，类型）进入？</p>

<p>如果想尝试，可以在<a href="https://www.rabbitmq.com/plugins.html">rabbitmq-management</a> 里找到一些有用的查看队列的插件。</p>

<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-six-php.html">Remote procedure call (RPC)</a></p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/05/03/php-rabbitmq-tutorial-six.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rabbitmq">rabbitmq</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="6ea38a2a9e019a47b8b5d3c036339681" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/04/27/php-rabbitmq-tutorial-five.html" class="article-date">
                      <time itemprop="datePublished">2016-04-27 18:27:03</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/04/27/php-rabbitmq-tutorial-five.html">PHP RabbitMQ 教程（五） - 主题</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <h3>主题</h3>

<p>(<a href="https://github.com/php-amqplib/php-amqplib">使用php-amqplib</a>)</p>

<p>在<a href="/2016/04/24/php-rabbitmq-tutorial-four.html">上一节</a>我们改善了日志系统(logging system，以下简称日志系统)，为了替代fanout类型的交换器，我们使用了一个direct类型的交换器，带来的好处是可以有选择的接收日志。</p>

<p>虽然使用direct交换器改善了系统，但是仍然有局限性 - 它不能根据多个条件进行路由。</p>

<p>在日志系统中，我们也许不仅仅想订阅严重等级的日志，也想订阅基于消息发布源的内容。也许你已经知道这个概念来自于UNIX的<a href="http://en.wikipedia.org/wiki/Syslog">syslog</a>工具，基于严重性(info/warn/crit&hellip;)和设备路由日志(auth/cron/kern&hellip;)的工具。</p>

<p>这可以提高灵活性 - 我们也许只想要监听来自&rsquo;cron&rsquo;的关键错误而不是来自&rsquo;kern&rsquo;的全部日志。</p>

<p>为了在我们的日志系统上实现这个功能，需要学习一个更复杂的 topic 交换器。</p>

<h3>Topic 交换器</h3>

<p>发送到 topic 交换器的消息不能随意设置 routing_key - 它必须是一个单词列表，以&rsquo;.&lsquo;分隔。单词可以是任何内容，但是通常会具体说明消息的功能。一些有效的routing key示例：样：&rdquo;stock.usd.nyse&rdquo;，&rdquo;nyse.vmw&rdquo;，&rdquo;quick.orange.rabbit&rdquo;。routing key 可以是任何长度的你喜欢的单词，最大255个字节。</p>

<p>binding key 也必须是同样的格式，topic交换器的逻辑和direct交换器类似 - 带有特定routing key的消息会被派发到所有绑定了binding key的队列，然而对于binding key依然有两个重要的特殊情况：</p>

<pre><code>*可以代替一个单词

#可以代替0个或多个单词
</code></pre>

<p>下图比较好的解释了这个情况：</p>

<p><img src="/images/rabbitmq/python-five.png" alt="" /></p>

<p>在这个例子中，我们准备全部发送描述动物的消息。这些消息带有由三个单词(两个点号分隔)组成的routing key，其中第一个单词表示速度，第二个表示颜色，第三个表示种类：&rdquo;<speed>.<colour>.<species>&ldquo;。</p>

<p>我们创建三个绑定：Q1的binding key为&rdquo;*.orange&rdquo;，Q2的binding key为&rdquo;*.*.rabbit&rdquo;和&rdquo;lazy.#&ldquo;。</p>

<p>这些绑定可以概括为：</p>

<pre><code>Q1 关注所有orange的动物

Q2 想知道所有关于兔子（rabbits）和懒惰动物（lazy animals）的消息。
</code></pre>

<p>routing key为&rdquo;quick.orange.rabbit&rdquo;的消息会被发送到两个队列，&rdquo;lazy.orange.elephant&rdquo;也会被发送到这两个队列。而&rdquo;quick.orange.fox&rdquo;则只会发送到第一个队列，&rdquo;lazy.brown.fox&rdquo;会被只发送到第二个队列。&rdquo;lazy.pink.rabbit&rdquo;会只被发送到第二个队列一次，即使它匹配两个绑定。&rdquo;quick.brown.fox&rdquo;不匹配任何绑定，所以会被丢弃。</p>

<p>如果打破规则，发送一条带有一个或四个单词，如&rdquo;orange&rdquo;或&rdquo;quick.orange.male.rabbit&rdquo;会怎么样？好吧，消息会丢失，因为它不匹配任何一个绑定。</p>

<p>但是，&rdquo;lazy.orange.male.rabbit&rdquo;这种消息，即使它有4个单词，依然会匹配最后一个绑定，然后被发送到第二个队列。</p>

<h4>topic 交换器</h4>

<pre><code>topic 交换器非常强大，可以表现得跟其他交换器一样。

当一个队列的binding key为&quot;#&quot;时，它会接收所有消息，忽略routing key，像fanout交换器一样。

当绑定中不存在&quot;*&quot;和&quot;#&quot;时，topic交换器会表现的跟direct交换器一样。

</code></pre>

<h3>整合</h3>

<p>我们准备在日志系统中使用topic交换器。假定日志的routing key由两个单词：&rdquo;<facility>.<severity>&ldquo;组成。</p>

<p>代码与上一节的几乎一致。</p>

<p>emit_log_topic.php：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection-&gt;channel();

$channel-&gt;exchange_declare('topic_logs', 'topic', false, false, false);

$routing_key = isset($argv[1]) &amp;&amp; !empty($argv[1]) ? $argv[1] : 'anonymous.info';
$data = implode(' ', array_slice($agrv, 2));
if(empty($data)) $data = &quot;Hello Wrold!&quot;;

$msg = new AMQPMessage($data);

$channel-&gt;basic_publish($msg, 'topic_logs', $routing_key);

echo &quot; [x] Sent &quot;,$routing_key,':',$data,&quot; \n&quot;;

$channel-&gt;close();
$connection-&gt;close();

?&gt;
</code></pre>

<p>receive_logs_topic.php：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection-&gt;channel();

$channel-&gt;exchange_declare('topic_logs', 'topic', false, false, false);

list($queue_name, ,) = $channel-&gt;queue_declare(&quot;&quot;, false, false, true, false);

$binding_keys = array_slice($argv, 1);
if( empty($binding_keys) ){
  file_put_contents('php://stderr', &quot;Usage: $argv[0] [binding_key]\n&quot;);
  exit(1);
}

foreach($binding_keys as $binding_key){
  $channel-&gt;queue_bind($queue_name, 'topic_logs', $binding_key);
}

echo ' [*] Waiting for logs. To exit press CTRL+C', &quot;\n&quot;;

$callback = function($msg){
  echo ' [*] ',$msg-&gt;delivery_info['routing_key'], ':', $msg-&gt;body, &quot;\n&quot;;
}

$channel-&gt;basic_consume($queue_name, '', false, true, false, false, $callback);

while(count($channel-&gt;callbacks)){
  $channel-&gt;wait();
}

$channel-&gt;close();
$connection-&gt;close();

?&gt;
</code></pre>

<p>接收所有日志：</p>

<pre><code>php receive_logs_topic.php '#'
</code></pre>

<p>接收所有来自&rdquo;kern&rdquo;的日志：</p>

<pre><code>php receive_logs_topic.php &quot;kern.*&quot;
</code></pre>

<p>只接收&rdquo;致命(critical)&ldquo;日志：</p>

<pre><code class="language-shell">php receive_logs_topic.php &quot;*.critical&quot;
</code></pre>

<p>创建多个绑定：</p>

<pre><code class="language-shell">php receive_logs_topic.php &quot;kern.*&quot; &quot;*.critical&quot;
</code></pre>

<p>发布routing key为&rdquo;kern.critical&rdquo;的日志就输入：</p>

<pre><code class="language-shell">php emit_log_topic.php &quot;kern.critical&quot; &quot;A critical kernel error&quot;
</code></pre>

<p>注意此代码并没有做路由或捆绑的例子，也许你想试一下两个以上的routing key参数。</p>

<p>一些问题：</p>

<p>​   <a href="http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_1">&ldquo;*&ldquo;会匹配routing key为空的消息吗？</a></p>

<p>​   <a href="http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_2">&rdquo;#.*&ldquo;会匹配内容为&rdquo;..&ldquo;的消息吗？会匹配一个单词的消息吗？</a></p>

<p>​   <a href="http://www.rabbitmq.com/tutorials/tutorial-five-php.html#teaser_answer_3">&ldquo;a.*.#&ldquo;和&rdquo;a.#&ldquo;的区别是什么？</a></p>

<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_topic.php">emit_log_topic.php完整代码</a> <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_topic.php">receive_logs_topic.php完整代码</a></p>

<p>下一步，在第六节中学习像远程过程调用一样完成消息往返。</p>

<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-five-php.html">Topics</a></p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/04/27/php-rabbitmq-tutorial-five.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rabbitmq">rabbitmq</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="b206d1225ea20949c68ccf70cf7fb4bb" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/04/24/php-rabbitmq-tutorial-four.html" class="article-date">
                      <time itemprop="datePublished">2016-04-24 14:16:41</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/04/24/php-rabbitmq-tutorial-four.html">PHP RabbitMQ 教程（四） - 路由</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <h3>路由</h3>

<p>（使用<a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a>）
在<a href="/2016/04/23/php-rabbitmq-tutorial-three.html">上一节</a>中，我们创建了一个简单的日志系统（logging system）。我们已经可以广播日志消息到多个接收者了。</p>

<p>在本节中，我们要给它增加一个功能-使它能够只订阅消息的一个子集。比如，只把严重的错误信息写入到日志文件（存储到磁盘）中，但同时仍然会把所有日志信息输出到控制台中。</p>

<h3>绑定</h3>

<p>在上一节中我们已经创建了绑定（bindings），代码如下：</p>

<pre><code>$channel-&gt;queue_bind($queue_name,'logs');
</code></pre>

<p>绑定（bindings）是指交换器（exchange）和队列（queue）的关系。可以简单的理解为：这个队列对这个交换器中的消息感兴趣。</p>

<p>绑定的时候可以带一个额外的 routing_key 参数。为了避免与$channel::basic_publish的参数混淆，我们把它叫做 binding_key，所以我们这样使用key创建一个绑定：</p>

<pre><code>$binding_key = 'black';
$channel-&gt;queue_bind($queue_name,$exchange_name,$binding_key);
</code></pre>

<p>binding key的意义取决于交换器的类型。我们之前使用过的fanout类型的交换器，会忽略这个值。</p>

<h3>Direct 交换器</h3>

<p>之前创建的日志系统分发所有消息到所有的消费者。我们打算扩展一下，使它可以过滤严重的消息。比如，我们只想在接收到严重错误的时候才写入到磁盘中，不在警告或普通的消息上浪费磁盘空间。</p>

<p>我们使用的是没有太多扩展性的fanout交换器，它仅能够简单的广播消息。</p>

<p>我们将要使用一个direct交换器代替fanout交换器。路由算法很简单-只有binding key完全匹配routing key的消息会进入队列。</p>

<p>为了说明，考虑如下的场景：</p>

<p><img src="/images/rabbitmq/direct-exchange.png" alt="" /></p>

<p>在这个场景中，我们可以看到direct类型的交换器X有两个队列，第一个队列使用orange作为binding key，第二个队列有两个绑定，一个是black另一个是green。</p>

<p>在这个场景中，当routing key为orange的消息发送到交换器，将会被路由到队列Q1。routing key为black或green的消息将会发送到Q2。其他的消息则会被丢弃。</p>

<h3>多个绑定</h3>

<p><img src="/images/rabbitmq/direct-exchange-multiple.png" alt="" /></p>

<p>使用相同的binding key绑定多个队列是合法的。在这个例子中，我们会使用black作为binding key为X和Q1之间添加一个绑定。这样一来，direct 交换器就表现得跟fanout交换器一样，分发消息到匹配的队列。routing key为black的消息就会被分发到Q1和Q2。</p>

<h3>发送日志</h3>

<p>我们将要对日志系统使用这个模型，我们将要发送消息到一个direct交换器。将日志级别作为routing key。这样一来接收端程序就可以选择它想要接收的消息了。首先来看看发送日志。</p>

<p>和以往一样，需要创建一个交换器：</p>

<pre><code>$channel-&gt;exchange_declare('direct_logs','direct',false,false,false);
</code></pre>

<p>然后准备发送消息：</p>

<pre><code>$channel-&gt;exchange_declare('direct_logs','direct',false,false,false);
$channel-&gt;basic_publish($msg,'direct_logs',$severity);
</code></pre>

<p>为了简化，我们可以假定&rsquo;severity&rsquo;的值可以是&rsquo;info&rsquo;,&lsquo;warning&rsquo;,&lsquo;error&rsquo;中的一个。</p>

<h3>订阅</h3>

<p>接收消息的脚本会跟之前一样正常工作，但是我们准备为每一个我们感兴趣的日志级别创建一个新的绑定。</p>

<pre><code>foreach($severities as $severity){
	$channel-&gt;queue_bind($queue_name,'direct_logs',$severity);
}
</code></pre>

<h3>整合</h3>

<p><img src="/images/rabbitmq/python-four.png" alt="" /></p>

<p>emit_log_direct.php类的代码为：</p>

<pre><code class="language-php">&lt;?php
require_once __DIR__ . '/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStremConnection('localhost',5672,'guest','guest');
$channel = $connection-&gt;channel();

$channel-&gt;exchange_declare('direct_logs','direct',false,false,false);

$severity = isset($argv[1]) &amp;&amp; !empty($argv[1]) ? $argv[1] : 'info';

$data = implode(' ',array_slice($argv,2));
if(empty($data)) $data = “Hello World!”;

$msg = “[x] Sent ”,$severity,':',$data,” \n”;

$channel-&gt;close();
$connection-&gt;close();
?&gt;
</code></pre>

<p>receive_logs_direct.php的代码为：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ . '/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;

$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');
$channel = $connection-&gt;channel();

$channel-&gt;exchange_declare('direct_logs','direct',false,false,false);

list($queue_name, ,) = $channel-&gt;queue_declare(“”,false,false,true,false);

$severities = array_slice($argv,1);
if(empty($severities)){
	file_put_contents('php://stderr',”Usage:$argv[0][info][warning][error]\n”);
	exit(1);
}

foreach($severities as $severity){
	$channel-&gt;queue_bind($queue_name,'direct_logs',$severity);
}

echo '[*]Waiting for logs.To exit press CTRL+C',”\n”;

$callback = function($msg){
	echo '[*]',$msg-&gt;delivery_info['routing_key'],':',$msg-&gt;body,”\n”;	
};

$channel-&gt;basic_consume($queue_name,'',false,true,false,false,$callback);

while(count($channel-&gt;callbacks)){
	$channel-&gt;wait();
}

$channel-&gt;close();
$connection-&gt;close();
?&gt;
</code></pre>

<p>如果你想只保存&rsquo;warning&rsquo;或&rsquo;error&rsquo;（而不是&rsquo;info&rsquo;）级别的消息，只需要打开命令行输入：</p>

<pre><code>php receive_logs_direct.php warning error &gt; logs_from_rabbit.log
</code></pre>

<p>如果你想在屏幕上输出所有的消息，打开一个新的终端，输入：</p>

<pre><code class="language-php">php receive_logs_direct.php info warning error
[*]Waiting for logs.To exit press CTRL+C
</code></pre>

<p>例如，发送error消息，输入：</p>

<pre><code>php emit_log_direct.php error &quot;Run. Run. Or it will explode.&quot;
[x] Sent 'error':'Run. Run. Or it will explode.'
</code></pre>

<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log_direct.php">emit_log_direct.php源码</a>  <a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs_direct.php">receive_logs_direct.php源码</a></p>

<p>转到第五节，查看如何监听基于模式的消息。</p>

<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-four-php.html">Routing</a></p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/04/24/php-rabbitmq-tutorial-four.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rabbitmq">rabbitmq</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="c17518e6e0380a4b4b7aad4d7ad7457b" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/04/23/php-rabbitmq-tutorial-three.html" class="article-date">
                      <time itemprop="datePublished">2016-04-23 19:58:17</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/04/23/php-rabbitmq-tutorial-three.html">PHP RabbitMQ 教程（三） - 发布/订阅</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <h3>发布/订阅</h3>

<p>我们在<a href="/2016/04/17/php-rabbitmq-tutorial-two.html">上一节</a>创建了一个工作队列，并假定队列对应的任务传送给了某个客户端。在这一章节我们会做一些完全不一样的东西&ndash;我们会发送一条消息到多个消费者，也称之为“发布/订阅”模式。</p>

<p>为了说明这个模式，我们会创建一个简单的日志系统（logging system，以下简称日志系统），它由两个程序组成&ndash;第一个是发送日志信息，第二个是接收日志并打印。</p>

<p>日志系统的每一个运行的接收端程序都会接收信息，这样就可以运行一个接收端就把日志保存到硬盘里，同时运行另一个接收端去实时显示日志到屏幕。</p>

<p>本质上，日志内容是广播给所有的接收端的。</p>

<h3>交换器</h3>

<p>在之前的章节中我们从一个队列里发送和接收消息，现在该把完整的RabbitMQ消息模型介绍给大家了。</p>

<p>让我们快速的回看一遍在之前的章节中的内容：</p>

<pre><code>&gt;生产者是一个用来发送消息的程序

&gt;队列是一个存储消息的缓冲区

&gt;消费者是一个接收消息的程序
</code></pre>

<p>RabbitMQ消息模型的核心思想是，生产者永远不会直接发送给任何消息队列，实际上，生产者一般情况下甚至不知道消息应该发送给哪个队列。</p>

<p>生产者只能发送消息到交换器中，交换器非常简单。一方面从生产者接收消息，另一方面把消息推送到队列中。交换器必须知道如何处理接收到的消息，是推送到某个队列？推送到多个队列？还是丢弃这条消息。这个规则通过交换器类型(exchange type)来指定。</p>

<p><img src="/images/rabbitmq/exchanges.png" alt="" /></p>

<p>这里是交换器的几个类型：direct,topic,headers,fanout。这里我们主要关注最后一个&ndash;fanout，创建一个类型为 fanout 的交换器，命名为 logs。</p>

<pre><code>$channel-&gt;exchange_declare('logs','fanout',false,false,false);
</code></pre>

<p>fanout交换器非常简单，你可以从名称中猜出它的功能，它把所有接收到的消息广播给所有它知道的队列，这也正是我们的日志系统需要的功能。</p>

<h4>列出交换器</h4>

<p>可以使用rabbitmqctl 命令列出服务器上的所有交换器：</p>

<pre><code>sudo rabbitmqctl list_exchanges

Listing exchanges ...
        direct
amq.direct      direct
amq.fanout      fanout
amq.headers     headers
amq.match       headers
amq.rabbitmq.log        topic
amq.rabbitmq.trace      topic
amq.topic       topic
logs    fanout
...done.
</code></pre>

<p>结果中有一些amq.*和一些未命名的交换器，这是一些默认创建的交换器，它们不太可能是现在需要用到的。</p>

<h4>未命名交换器</h4>

<p>在之前的章节中我们对交换器一无所知，直到可以发送消息给队列。大概是因为我们当时正在使用一个以空字符串“”定义的默认的交换器。</p>

<p>回想一下之前怎么发布消息：</p>

<pre><code>$channel-&gt;basic_publish($msg,'','hello');
</code></pre>

<p>这里就是使用默认或者说未命名的交换器：消息被routing_key的值
Here we use the default or nameless exchange: messages are routed to the queue with the name specified by routing_key, if it exists. The routing key is the second argument to basic_publish</p>

<p>现在，可以发布消息到这个队列。</p>

<pre><code>$channel-&gt;exchange_declare('logs','fanout',false,false,false);
$channel-&gt;basic_publish($msg,'logs');
</code></pre>

<h3>临时队列</h3>

<p>也许你还记得在之前我们使用了一个指定的队列（还记得 hello 队列 和 task_queue 队列吗？）。可以命名一个队列是至关重要的&ndash;我们需要指定一个worker到同一个队列。当想让生产者和消费者使用同一个队列时给队列命名是非常重要的。</p>

<p>但是在我们的日志系统中情况不同了，我们想要接收所有的消息，不仅仅是其中的一部分，我们关心的是最新的消息而不是旧的，因此需要做两件事。</p>

<p>首先，当连接到RabbitMQ时，需要一个空的队列，可以手动创建一个名字随机的队列，或者，更好的办法是，让服务器为我们随机选一个队列名字。</p>

<p>其次，一旦与消费者失去连接，队列需要自动删除。</p>

<p>在<a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a>中，当我们创建了一个名字为空的队列时，实际上是创建了一个被生成了名字的非持久化的队列。</p>

<pre><code>list($queue_name, ,) = $channel-&gt;queue_declare(&quot;&quot;);
</code></pre>

<p>方法执行后，$queue_name变量包含了一个RabbitMQ生成的字符串。比如也许是这样的：amq.gen-JzTY20BRgKO-HjmUJj0wLg。</p>

<p>当连接被关闭的时候，队列也会被删掉，因为队列是独有的。</p>

<h3>绑定(Bindlings)</h3>

<p><img src="/images/rabbitmq/bindings.png" alt="" /></p>

<p>我们已经创建了一个fanout类型的交换器和一个队列。现在需要让交换器发送消息给队列。交换器和队列之间的关系称之为绑定(binding)</p>

<pre><code>$channel-&gt;queue_bind($queue_name,'logs');
</code></pre>

<p>现在开始，logs 交换器会把消息附加到队列中。</p>

<h4>列出绑定（Listing bindings）</h4>

<p>可以使用 rabbitmqctl list_bindings列出所有存在的正在使用的绑定。</p>

<h3>整合</h3>

<p><img src="/images/rabbitmq/python-three-overall.png" alt="" /></p>

<p>发送日志消息的生产者，与之前的代码看起来没什么不同，最重要的变化是现在想要发送消息到我们的 logs 交换器中，需要在发送时提供一个routing_key，但是在 fanout类型的交换器中这个值是可以忽略的。下边是emit_log.php的代码。</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ .'/verdor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');
$channel = $channel-&gt;channel();

$channel-&gt;exchange_declare('logs','fanout',false,false,false);

$data = implode(' ',array_slice($argv,1));

if(empty($data)) $data = &quot;info:Hello World&quot;;
$msg = new AMQPMessage($data);

$channel-&gt;basic_publish($msg,'logs');

echo &quot;[x]Sent &quot;,$data,&quot;\n&quot;;

$channel-&gt;close();
$connection-&gt;close();
?&gt;
</code></pre>

<p>(<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/emit_log.php">emit_log.php</a>)</p>

<p>如你所见，建立连接后声明了交换器，这一步是必须的，因为发送消息到一个不存在的交换器是被禁止的。</p>

<p>如果还没有队列绑定到交换器，信息会丢失，但是这对于我们是可以的，如果没有消费者监听，我们可以安全的丢弃消息。</p>

<p>receive_logs.php：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ .'/vendor/autoload.php';
use PhpAmqpLib\Connection\QMAPStreamConnection;

$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');
$channel = $connection-&gt;channel();

$channel-&gt;queue_bind($queue_name,'logs');

echo '[*] Waiting for logs. To exit press CTRL+C',&quot;\n&quot;;

$callback = function($msg){
	echo '[x]',$msg-&gt;body,&quot;\n&quot;;
};

$channel-&gt;basic_consume($queue_name,'',false,true,false,false,$callback);

whild(count($channel-&gt;callbacks)){
	$channel-&gt;wait();
}

$channel-&gt;close();
$connection-&gt;close();
?&gt;
</code></pre>

<p>(<a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/receive_logs.php">receive_logs.php</a>)</p>

<p>如果想保存日志到文件中，可以在命令中输入</p>

<pre><code>php receive_logs.php &gt; logs_from_rabbit.log
</code></pre>

<p>如果想在屏幕上查看日志，新打开一个终端并运行：</p>

<pre><code>php receive_logs.php
</code></pre>

<p>发送日志：</p>

<pre><code>php emit_log.php
</code></pre>

<p>使用 rabbitmqctl list_bindings 可以确认代码确实创建了绑定和队列，当两个receive_logs.php在运行的时候会看到类似这样的：</p>

<pre><code>sudo rabbitmqctl list_bindings
Listing bindings ...
logs    exchange        amq.gen-JzTY20BRgKO-HjmUJj0wLg  queue           []
logs    exchange        amq.gen-vso0PVvyiRIL2WoV3i48Yg  queue           []
...done.

</code></pre>

<p>对于结果的解释很简单，logs交换器中的数据发送到两个服务器指定的队列，而这正是我们要实现的。</p>

<p>想要弄明白怎样去监听部分消息，转到第四部分。</p>

<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-three-php.html">Publish/Subscribe</a></p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/04/23/php-rabbitmq-tutorial-three.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rabbitmq">rabbitmq</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        
        
                <article id="084cd06d288b3261464bee7560a21d01" class="article" itemscope itemprop="blogPost">
                  <div class="article-meta">
                    <a href="https://www.qichengzx.com/2016/04/17/php-rabbitmq-tutorial-two.html" class="article-date">
                      <time itemprop="datePublished">2016-04-17 14:39:30</time>
                    </a>
                    <div class="article-category">
                      <a class="article-category-link" href="/categories/php">php</a>
                    </div>
                  </div>
                  <div class="article-inner">
                    <header class="article-header">
                      <h1 itemprop="name">
                        <a class="article-title" href="https://www.qichengzx.com/2016/04/17/php-rabbitmq-tutorial-two.html">PHP RabbitMQ 教程（二） - 工作队列</a>
                      </h1>
                    </header>
                    <div class="article-entry" itemprop="articleBody">
                      <h3>工作队列</h3>

<h5>（使用<a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a>库）</h5>

<p><img src="/images/rabbitmq/python-two.png" alt="" /></p>

<p>在本教程<a href="/2016/02/28/php-rabbitmq-tutorial-one.html">第一部分</a> 我们已经写完了从一个指定队列发送和接收消息的程序。在这一章节中，我们会创建一个工作队列（Work Queue）来分发耗时的任务给多个工作者（worker）。</p>

<p>工作队列（也被称为 任务队列-task queue）主要是避免立即执行资源密集型任务并且还要等待它执行完毕。相反，需要让任务稍后执行，我们把一个任务当做一条信息发送给队列，后台运行的工作者（worker）会取出任务并执行，当运行多个worker时任务会在它们之间共享。</p>

<p>这个概念在web应用中非常有用，可以在短暂的HTTP请求期间处理一些复杂的任务。</p>

<h3>准备工作</h3>

<p>在前面的部分我们发送了一条内容为“Hello World”的信息，现在我们会发送一些字符串，把这些字符串当做复杂的任务，我们并没有一个实际的任务，像是图片缩放，或者转换PDF文件，所以我们使用sleep方法来假设任务很繁忙。我们会在字符串中加入一些“.”来表示复杂复杂程度；每一个“.”表示需要耗时1秒，比如，“Hello &hellip;”代表需要耗时3秒。</p>

<p>我们从上一节的基础上稍微改动了一下send.php，来允许消息可以从命令行发送，这个程序会发送任务到队列中，把它命名为new_task.php</p>

<pre><code>$data = impllode(' ',array_slice($argv,1));
if(empty($data))$data = &quot;Hello World&quot;;
$msg = new AMQPMessage($data,
	array('delivery_mode'=&gt;2)#设置消息持久化，下边会讲到。
);
$channel-&gt;basic_publish($msg,'','task_queue');
echo &quot;[x] Sent &quot;,$data,&quot;\n&quot;;
</code></pre>

<p>上一节的receive.php也需要一些改动：需要为消息中的每一个“.”模拟1秒的工作。它会从队列中取出消息并运行，把它命名为worker.php：</p>

<pre><code>$callback = function($msg){
	echo &quot;[x] Received &quot;,$msg-&gt;body,&quot;\n&quot;;
	sleep(substr_count($msg-&gt;body,'.'));
	echo &quot;[x] Done&quot;,&quot;\n&quot;;
	$msg-&gt;delivery_info['channel]-&gt;basic_ack($msg-&gt;delivery_info['delivery_tag']);
};

$channel-&gt;basic_gos(null,1,null);
$channel-&gt;basic_consume('task_queue','',false,false,false,false,$callback);
</code></pre>

<p>注意我们伪造的任务需要花费时间（即发送的字符串中要有一些&rdquo;.&ldquo;）</p>

<p>然后运行：</p>

<pre><code>php new_task.php &quot;A very hard task which takes two seconds..&quot;
php wordker.php
</code></pre>

<h3>轮询分发</h3>

<p>使用工作队列的一个好处就是它能够并行的处理队列。如果有太多工作需要处理，只需要添加新的worker就可以了。</p>

<p>首先，我们试着同时运行两个worker.php，它们都会从队列接收到消息，但是到底是不是这样呢？我们看一下。</p>

<p>此时需要打开3个终端，其中两个运行worker.php，这两个就是我们的消费者 - C1和C2。</p>

<p>shell1</p>

<pre><code>php worker.php
[*] Waiting for messages. To exit press CTRL+C
</code></pre>

<p>shell2</p>

<pre><code>php worker.php
[*] Waiting for messages. To exit press CTRL+C
</code></pre>

<p>在第三个终端中我们会发送新的任务，消费者程序开始运行后就可以发送一些消息了。</p>

<p>shell3</p>

<pre><code>php new_task.php First message.
php new_task.php Second message..
php new_task.php Third message...
php new_task.php Fourth message....
php new_task.php Fifth message.....
</code></pre>

<p>我们看一下发送给worker的是什么:</p>

<p>shell1</p>

<pre><code>php worker.php
[*] Waiting for messages.To exit press CTRL+C
[x]Received 'First message.'
[x]Received 'Third message...'
[x]Received 'Fifth message.....'
</code></pre>

<p>shell2</p>

<pre><code>php worker.php
[*] Waiting for messages.To exit press CTRL+C
[x]Received 'Second message.'
[x]Received 'Fourth message...'
</code></pre>

<p>RabbitMQ会默认按顺序把消息发送给下一个消费者，平均每个消费者都会得到一样多数量的消息，这种分发消息的方式叫做轮询。试着添加三个或更多个worker来运行。</p>

<h3>消息响应</h3>

<p>执行一个任务会消耗一定的时间，也许你想知道如果一个消费者在执行一个耗时较长的任务时但是在执行一部分的时候挂掉会发生什么。在我们当前的代码中，一旦RabbitMQ把消息分发给消费者便会立即从内存中移除。这种情况下，如果停止一个worker，它正在处理的消息就会丢失。同时其他所有发送给这个worker的还没有处理的消息也会丢失。</p>

<p>但是我们不想丢失任何任务，如果一个worker挂掉，需要把任务发送到另一个worker。</p>

<p>为了确保消息永不丢失，RabbitMQ支持消息响应（message acknowledgements），消费者会发送一个响应告诉RabbitMQ已经收到了某条消息，并且已经处理，这样RabbitMQ就可以删掉它了。</p>

<p>如果一个消费者程序在未发送响应之前挂掉了（频道关闭，链接关闭，或者TCP连接丢失），RabbitMQ会认为消息没有完全处理然后会重新推送到队列中。如果此时有其他的消费者程序在运行，RabbitMQ会很快把消息发送给另一个消费者。这样就可以确保消息不会丢失，即使worker偶尔挂掉。</p>

<p>消息是没有超时的概念的，当worker断开连接的时候，RabbitMQ会重新发送消息，这样在处理一个耗时较长的消息任务时就不会出现问题了。</p>

<p>消息响应默认是关闭的。可以通过设置basic_consume的第四个参数为false(true表示不开启应答)，然后在处理完任务的时候从worker发送一个正确的响应内容。</p>

<pre><code class="language-php">$callback = function($msg){
	echo &quot;[x] Received &quot;,$msg-&gt;body,&quot;\n&quot;;
	sleep(substr_count($msg-&gt;body,'.'));
	echo &quot;[x] Done&quot;,&quot;\n&quot;;
	$msg-&gt;delivery_info['channel]-&gt;basic_ack($msg-&gt;delivery_info['delivery_tag]);
};
$channel-&gt;basic_consume('task_queue','',false,false,false,false,$callback);
</code></pre>

<p>这样我们就可以确保当你CTRL+C杀掉一个正在处理消息的worker的时候，消息并不会丢失。在这个worker挂掉之后，所有未响应的消息就会发送。</p>

<h3>忘了响应</h3>

<p>一个很容易犯的错误就是忘了basic_ack，后果很严重。消息会在程序退出后重新发送（可能看起来像是随机返还 原文：which may look like random redelivery），但是如果它不释放未响应的消息，RabbitMQ就会占用越来越多的内存。</p>

<p>为了排除这种错误可以使用rabbitmqctl来打印messages_unacknowledges字段：</p>

<pre><code>sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged

Listing queues ...
hello    0       0
...done.
</code></pre>

<h3>消息持久化</h3>

<p>我们已经学习了确保即使消费者程序挂掉，任务也不会丢失。但是任务还是会在RabbitMQ服务停止的时候丢失。</p>

<p>当RabbitMQ退出或崩溃，它会丢失之前所有的队列和消息，除非你特意告诉它。所以我们必须把队列和消息设为持久化。</p>

<p>首先，为了队列不丢失，需要把它声明为<i>持久化（durable）</i>，所以修改queue_declare的第三个参数为true：</p>

<pre><code>$channel-&gt;queue_declare('hello',false,true,false,false);
</code></pre>

<p>尽管这行代码本身是正确的，但是仍然不会正确运行。因为在之前已经定义过一个非持久化的 hello 队列。RabbitＭＱ不允许使用不同参数重新定义一个已经存在的队列，它会返回一个错误。但是可以用一个快捷的方法去解决，定义一个不同名字的队列，比如 task_queue：</p>

<pre><code>$channel-&gt;queue_declare('task_queue',false,true,false,false);
</code></pre>

<p>需要把生产者和消费者程序都设置为 true。</p>

<p>这时候，我们就可以确保在RabbitMQ重启之后task_queue队列不会丢失。现在需要设置消息持久化了 - 通过设置AMQPMessage的属性数组中消息属性 delivery_mode = 2来达到。</p>

<pre><code>$msg = new AMQPMessage($data,
		array('delivery_mode'=&gt;2) //设置消息持久化
	);
</code></pre>

<h3>关于消息持久化的说明</h3>

<p>设置消息持久化并不能完全保证消息不会丢失。这只是告诉让RabbitMQ要把消息保存到硬盘，但是从RabbitMQ接收到消息到保存完成仍然还有一个短暂的间隔时间。因为RabbitMQ并不是每一条消息都会使用fsync(2)，可能只是保存到缓存中而不是真正的写到磁盘里。并不能保证消息真正的持久化，但是对于简单的工作队列已经足够了。如果你需要更健壮的持久化，可以使用<a href="https://www.rabbitmq.com/confirms.html">publisher confirms</a>机制。</p>

<h3>公平分发</h3>

<p>也许你注意到它仍没有像我们想的那样去派发任务，比如在两个worker的情况下，处理奇数消息的比较繁忙，处理偶数消息的比较轻松，一个worker不断的忙碌而另一个几乎不需要工作，但是RabbitmQ并不知道这些，并且继续一如既往的派发消息。</p>

<p>这是因为RabbitMQ在消息进入队列的时候只管去派发，并不管消费者未做出响应的消息数。它只是把每第n条消息发送给第n个消费者。</p>

<p>我们可以使用basic_qos方法，并设置prefetch_count = 1。这样是告诉RabbitMQ在同一时刻不要发送超过1条消息给一个worker，或者说，不要发送新的消息给worker直到它已处理完上一条消息并作出了响应。这样，它就会把消息发送给下一个空闲的worker了。</p>

<p><img src="/images/rabbitmq/prefetch-count.png" alt="" /></p>

<pre><code>$channel-&gt;basic_qos(null,1,null);
</code></pre>

<h3>注意队列长度</h3>

<p>如果所有的worker都处于忙碌状态，队列就会填满，你需要留意，添加更多的worker，或者使用其他的策略。</p>

<h3>整合</h3>

<p>最终，new_task.php的代码如下：</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ .'/verdor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');
$channel = $connection-&gt;channel();

$channel-&gt;queue_declare('task_queue',false,true,false,false);

$data = implode(' ',array_slice($argv,1));

if(empty($data)) $data = &quot;Hello World!&quot;;

$msg = new AMQPMessage($data,
	array('delivery_mode'=&gt;2) // 消息持久化
);
$channel-&gt;basic_publish($msg,'','task_queue');

echo &quot;[x]Sent &quot;, $data, &quot;\n&quot;;

$channel-&gt;close();
$connection-&gt;close();
?&gt;
</code></pre>

<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/new_task.php">new_task.php源码</a></p>

<p>worker.php</p>

<pre><code class="language-php">&lt;?php

require_once __DIR__ .'/vendor/autoload.php';
use PhpAmqpLib\Connection\AMQPStreamConnection;

$connection = new AMQPStreamConnection('localhost',5672,'guest','guest');
$channel = $connection-&gt;channel();

$channel-&gt;queue_declare('task_queue',false,true,false,false);

echo '[*] Waiting for messages.To exit press CTRL+C',&quot;\n&quot;;

$callback = function($msg){
	echo &quot;[x]Received &quot;,$msg-&gt;body,&quot;\n&quot;;
	sleep(substr_count($msg-&gt;body,'.'));
	echo &quot;[x]Done&quot;,&quot;\n&quot;;
	$msg-&gt;delivery_info['chennel']-&gt;basic_ack($msg-&gt;delivery_info['delivery_tag']);
};

$channel-&gt;basic_qos(null,1,null);
$channel-&gt;basic_consume('task_queue','',false,false,false,false,$callback);

while(count($channel-&gt;callbacks)){
	$channel-&gt;wait();
}

$channel-&gt;close();
$connection-&gt;close();
?&gt;
</code></pre>

<p><a href="http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/php/worker.php">worker.php</a></p>

<p>使用消息应答和prefetch_count=1后，就可以运行一个工作队列了，持久模式选项会在即使RabbitMQ重启的情况下保留任务。</p>

<p>现在我们可以继续学习第三部分的内容，学习如何发送相同的消息给多个消费者。</p>

<p>原文地址：<a href="https://www.rabbitmq.com/tutorials/tutorial-two-php.html">Work queues</a></p>

                    </div>
                    <footer class="article-footer">
                      <a href="https://www.qichengzx.com/2016/04/17/php-rabbitmq-tutorial-two.html#comments" class="article-comment-link">Comments</a>
                      
                        <ul class="article-tag-list">
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/php">php</a>
                          </li>
                        
                          <li class="article-tag-list-item">
                            <a class="article-tag-list-link" href="/tags/rabbitmq">rabbitmq</a>
                          </li>
                        
                        </ul>
                      
                    </footer>
                  </div>
                  <nav id="article-nav">
                    

                    
                  </nav>
                </article>

        

        
        


<nav id="page-nav">






  <a class="extend prev" rel="prev" href="/page/3/">« Prev</a>





  <a class="page-number" href="/">1</a>



  <a class="page-number" href="/page/2/">2</a>



  <a class="page-number" href="/page/3/">3</a>



  <span class="page-number current">4</span>



  <a class="page-number" href="/page/5/">5</a>



  <a class="page-number" href="/page/6/">6</a>




  <a class="extend next" rel="next" href="/page/5/">Next »</a>

</nav>


        
      
      </section>
      
      
            <aside id="sidebar">
            
    
                <div class="widget-wrap">
                  <h3 class="widget-title">Categories</h3>
                  <div class="widget">
                    <ul class="category-list">
                      
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/default/">default</a>
                        <span class="category-list-count">7</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/git/">git</a>
                        <span class="category-list-count">3</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/golang/">golang</a>
                        <span class="category-list-count">23</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/javascript/">javascript</a>
                        <span class="category-list-count">7</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/linux/">linux</a>
                        <span class="category-list-count">1</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/mysql/">mysql</a>
                        <span class="category-list-count">4</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/nginx/">nginx</a>
                        <span class="category-list-count">1</span>
                      </li>
                      
                      <li class="category-list-item">
                        <a class="category-list-link" href="/categories/php/">php</a>
                        <span class="category-list-count">12</span>
                      </li>
                      
                    </ul>
                  </div>
                </div>
    

            
    
                <div class="widget-wrap">
                  <h3 class="widget-title">Tags</h3>
                  <div class="widget">
                    <ul class="tag-list">
                      
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/ECharts/">ECharts</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/Keygen/">Keygen</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/captcha/">captcha</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/crontab/">crontab</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/discuz/">discuz</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/docker/">docker</a>
                        <span class="tag-list-count">2</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/dropbox/">dropbox</a>
                        <span class="tag-list-count">2</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/excel/">excel</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/fetch/">fetch</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/geo/">geo</a>
                        <span class="tag-list-count">3</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/gin/">gin</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/git/">git</a>
                        <span class="tag-list-count">3</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/github/">github</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/go/">go</a>
                        <span class="tag-list-count">22</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/goquery/">goquery</a>
                        <span class="tag-list-count">2</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/hexo/">hexo</a>
                        <span class="tag-list-count">3</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/https/">https</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/input/">input</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/javascript/">javascript</a>
                        <span class="tag-list-count">3</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/js/">js</a>
                        <span class="tag-list-count">2</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/laravel/">laravel</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/leetcode/">leetcode</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/linux/">linux</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/mysql/">mysql</a>
                        <span class="tag-list-count">7</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/nginx/">nginx</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/node/">node</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/pdo/">pdo</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/php/">php</a>
                        <span class="tag-list-count">14</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/qq/">qq</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/rabbitmq/">rabbitmq</a>
                        <span class="tag-list-count">6</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/react-native/">react-native</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/redigo/">redigo</a>
                        <span class="tag-list-count">3</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/redis/">redis</a>
                        <span class="tag-list-count">5</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/ssl/">ssl</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/time/">time</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/vps/">vps</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/vue/">vue</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/widget/">widget</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e4%bb%8a%e6%97%a5%e5%a4%b4%e6%9d%a1/">今日头条</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e6%a0%87%e8%af%86%e7%ac%a6/">标识符</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e7%88%b1%e5%a5%87%e8%89%ba/">爱奇艺</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e7%9f%ad%e7%bd%91%e5%9d%80/">短网址</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e7%b3%97%e7%99%be/">糗百</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e7%bd%91%e7%bb%9c%e8%af%b7%e6%b1%82/">网络请求</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                      <li class="tag-list-item">
                        <a class="tag-list-link" href="/tags/%e9%98%9f%e5%88%97/">队列</a>
                        <span class="tag-list-count">1</span>
                      </li>
                      
                    </ul>
                  </div>
                </div>
    

            
    
            <div class="widget-wrap">
              <h3 class="widget-title">Archives</h3>
              <div class="widget">
                <ul class="archive-list">
                  
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2015/11">2015/11</a>
                    <span class="archive-list-count">7</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2015/12">2015/12</a>
                    <span class="archive-list-count">4</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/01">2016/01</a>
                    <span class="archive-list-count">3</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/02">2016/02</a>
                    <span class="archive-list-count">4</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/04">2016/04</a>
                    <span class="archive-list-count">4</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/05">2016/05</a>
                    <span class="archive-list-count">3</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/07">2016/07</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/09">2016/09</a>
                    <span class="archive-list-count">3</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/10">2016/10</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/11">2016/11</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2016/12">2016/12</a>
                    <span class="archive-list-count">3</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2017/03">2017/03</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2017/06">2017/06</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2017/07">2017/07</a>
                    <span class="archive-list-count">2</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2017/08">2017/08</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2017/09">2017/09</a>
                    <span class="archive-list-count">3</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2017/11">2017/11</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2018/02">2018/02</a>
                    <span class="archive-list-count">4</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2018/04">2018/04</a>
                    <span class="archive-list-count">2</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2018/05">2018/05</a>
                    <span class="archive-list-count">6</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2018/06">2018/06</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2019/01">2019/01</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                  <li class="archive-list-item">
                    <a class="archive-list-link" href="/archives/2020/02">2020/02</a>
                    <span class="archive-list-count">1</span>
                  </li>
                  
                </ul>
              </div>
            </div>
    

            
    
            <div class="widget-wrap">
              <h3 class="widget-title">RECENTS</h3>
              <div class="widget">
                <ul>
                  
                  <li>
                    <a href="https://www.qichengzx.com/2020/02/02/graceful-shutdown-of-a-tcp-server-in-go.html">优雅的关闭Go TCP Server</a>
                  </li>
                  
                  <li>
                    <a href="https://www.qichengzx.com/2019/01/01/go-in-the-browser.html">【译】Go和WebAssembly：在浏览器中运行Go程序</a>
                  </li>
                  
                  <li>
                    <a href="https://www.qichengzx.com/2018/06/15/qq-007-captcha.html">腾讯防水墙验证码使用</a>
                  </li>
                  
                  <li>
                    <a href="https://www.qichengzx.com/2018/05/29/git-pull-upstream.html">Git 同步上游源更改</a>
                  </li>
                  
                  <li>
                    <a href="https://www.qichengzx.com/2018/05/13/create-a-single-page-app-with-go-echo-and-vue.html">【译】使用 Go，Echo 和 Vue 创建单页 TODO 应用</a>
                  </li>
                  
                </ul>
              </div>
            </div>
    

            </aside>

      
    </div>
    
        <footer id="footer">
          <div class="outer">
            <div id="footer-info" class="inner">
              &copy; 2020 启程<br>
              Powered by <a href="https://github.com/qichengzx/gopress" target="_blank">gopress</a>
            </div>
            </div>
        </footer>

  </div>
  
<nav id="mobile-nav">
  
  <a class="mobile-nav-link" href="/">Home</a>
  
  <a class="mobile-nav-link" href="/archives">Archives</a>
  
  <a class="mobile-nav-link" href="https://github.com/qichengzx">GitHub</a>
  
</nav>

  

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>


</div>
</body>
</html>
